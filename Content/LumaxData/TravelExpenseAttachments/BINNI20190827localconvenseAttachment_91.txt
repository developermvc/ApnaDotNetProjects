Text
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROCEDURE [DBO].[USP_TRAVELEXPENSE_INSERTUPDATE]

@TRVLEXPID					INT				=	0,
@FROMDATE					DATETIME		=	NULL,
@TODATE						DATETIME		=	NULL,
@USERCODE					VARCHAR(50),
@USERID						INT,
@CREATEDBY					VARCHAR(50),
@TOTALAMOUNT				NUMERIC(13,2)	=	0,
@XMLTRAVELDETAILS			NVARCHAR(MAX)	=	'',
@XMLTIFFINDETAILS			NVARCHAR(MAX)	=	'',
@XMLLODGINGDETAILS			NVARCHAR(MAX)	=	'',
@XMLOTHERDETAILS			NVARCHAR(MAX)	=	'',
@XMLFAREDETAILS				NVARCHAR(MAX)	=	'',
@MODE						VARCHAR(50),
@STATUS						INT,  
@REMARKS					VARCHAR(500)	=	'',
@NORMEDVAL  NORMEDVAL		READONLY,
@TRAVELEXPCODE				VARCHAR(50) OUTPUT

AS

BEGIN  

 DECLARE @IDOCUMNET INTEGER,@ILODGINGDOCUMNET INTEGER ,@IOTHERDOCUMNET INTEGER,@ITRAVELDOCUMNET INTEGER,@IFAREDOCUMNET INTEGER, @LASTID INT,@CODE VARCHAR(50)
 ,@UID INT,@STATUSNUMBER INT=0 ,@COUNT INT=0,@PLANTID  INT=0,@ISADMIN VARCHAR(2),@MAXSTATUS INT
 SET @UID=(SELECT [USER_ID] FROM ADM_USER WHERE USERCODE=@USERCODE)
 SELECT @PLANTID=[DBO].[FN_GETUSERWISEPLANT](@USERID,0,0,0)
 SELECT @ISADMIN=ISADMIN FROM ADM_USER WHERE USERCODE=@USERCODE

 IF(@MODE='INSERT')

BEGIN

 EXEC [DBO].[USP_GENRATE_OEM_DOC_NO] 'TLN','','','',@DOC_NO=@CODE OUTPUT

 SET @TRAVELEXPCODE=@CODE

 ---INSERT TRAVEL_EXP_HDR-----------------------------------------

INSERT INTO [DBO].[TRAVEL_EXP_HDR] ([TRAVELEXPCODE],[FROMDATE],[TODATE],[CREATEDID],[STATUS],PLANTID,[CREATEDBY],[CREATEDDATE],[TOTAL_AMOUNT],[USER_ID])
VALUES (@TRAVELEXPCODE,@FROMDATE,@TODATE,@USERID,@STATUS,@PLANTID,@CREATEDBY,GETDATE(),@TOTALAMOUNT,@UID)
SET @LASTID=IDENT_CURRENT('TRAVEL_EXP_HDR')

---INSERT TIFFIN EXP--------------------------------------------

IF(@XMLTIFFINDETAILS!='')

BEGIN

   EXEC SP_XML_PREPAREDOCUMENT @IDOCUMNET OUTPUT,@XMLTIFFINDETAILS
   INSERT INTO TRAVEL_TIFFIN([TRVLEXPID],[DATE] ,[AMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARKS],[ATTACHMENT],[CITYID])
   SELECT @LASTID ,[DATE],[AMOUNT],@CREATEDBY,GETDATE(),1,[REMARKS],[ATTACHMENT],[CITYID]
   FROM OPENXML(@IDOCUMNET, 'NEWDATASET/TRAVEL_TIFFIN', 2) WITH ([DATE] DATETIME,[AMOUNT] NUMERIC(13,2),[REMARKS] NVARCHAR(500),[ATTACHMENT] VARCHAR(250),[CITYID] INT)

END

---END TIFFIN EXP

---INSERT LODGING EXPENSE START

IF(@XMLLODGINGDETAILS!='')

BEGIN

  EXEC SP_XML_PREPAREDOCUMENT @ILODGINGDOCUMNET OUTPUT ,@XMLLODGINGDETAILS

  INSERT INTO TRAVEL_LODGING([TRVLEXPID],[CITYID],[FROMDATE] ,[TODATE],[NIGHTSPENT],[AMOUNT],[DAAMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK] ,[ATTACHMENT],[LOCALITY],[BILLNO] ,[INTIME],[OUTTIME])

  SELECT @LASTID,[CITYID] ,[FROMDATE],[TODATE],[NIGHTSPENT],[AMOUNT],[DAAMOUNT],@CREATEDBY,GETDATE(),1,[REMARK],[ATTACHMENT],[LOCALITY],[BILLNO], [INTIME], [OUTTIME]  

  FROM OPENXML(@ILODGINGDOCUMNET, 'NEWDATASET/TRAVEL_LODGING', 2) WITH ([CITYID] INT,[FROMDATE] DATETIME,[TODATE] DATETIME,[NIGHTSPENT] INT,[AMOUNT] NUMERIC(13,2)

 ,[DAAMOUNT] NUMERIC(13,2),[REMARK] NVARCHAR(500),[ATTACHMENT] VARCHAR(250),[LOCALITY] VARCHAR(250),[BILLNO] VARCHAR(150) ,[INTIME] VARCHAR(10),[OUTTIME] VARCHAR(10) )

END

---END INSERT LODGING EXPENSE

---INSERT OTHER EXPENSE START

IF(@XMLOTHERDETAILS!='')

BEGIN

  EXEC SP_XML_PREPAREDOCUMENT @IOTHERDOCUMNET OUTPUT ,@XMLOTHERDETAILS

  INSERT INTO TRAVEL_OTHER([TRVLEXPID],[DATE] ,[OTHEREXP_AMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK],[ATTACHMENT],[ACCOUNTID])

  SELECT @LASTID ,[DATE],[OTHEREXP_AMOUNT],@CREATEDBY,GETDATE(),1,[REMARK],[ATTACHMENT],[ACCOUNTID]

  FROM OPENXML(@IOTHERDOCUMNET, 'NEWDATASET/TRAVEL_OTHER', 2) WITH ([DATE] DATETIME,[OTHEREXP_AMOUNT] NUMERIC(13,2),[REMARK] NVARCHAR(500),[ATTACHMENT] VARCHAR(250),[ACCOUNTID] INT )

END

---END INSERT OTHER EXPENSE

---INSERT TRAVEL EXPENSE START

IF(@XMLTRAVELDETAILS!='')

BEGIN

  EXEC SP_XML_PREPAREDOCUMENT @ITRAVELDOCUMNET OUTPUT,@XMLTRAVELDETAILS

  INSERT INTO TRAVEL_EXP_DETAIL([TRVLEXPID],[DSRDTLID],[DATE] ,[SOURCE],[DESTINATION],[TRAVELMODEID],[FARE],[DISTANCE],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK],[ATTACHMENT])

  SELECT @LASTID ,[DSRDTLID],[DATE],[SOURCE],[DESTINATION],[TRAVELMODEID],[FARE],[DISTANCE],@CREATEDBY,GETDATE(),1,[REMARK],[ATTACHMENT]

  FROM OPENXML(@ITRAVELDOCUMNET, 'NEWDATASET/TRAVEL_EXP_DETAIL', 2) WITH (

  [DSRDTLID] INT ,[DATE] DATETIME,[SOURCE] VARCHAR(100),[DESTINATION] VARCHAR(100),[TRAVELMODEID] INT,[FARE] NUMERIC(13,2),[DISTANCE] NUMERIC(13,2),[REMARK] NVARCHAR(500),[ATTACHMENT] VARCHAR(250)  )

END

---END INSERT LODGING EXPENSE

---INSERT FARE EXPENSE START

IF(@XMLFAREDETAILS!='')

BEGIN

 EXEC SP_XML_PREPAREDOCUMENT @IFAREDOCUMNET OUTPUT,@XMLFAREDETAILS

 INSERT INTO TRAVEL_FARE([TRVLEXPID],[FROMSTATION],[TOSTATION] ,[DEPDATE],[ARRDATE],[TRAVELMODE],[TICKETNO],[FARE],[REMARK],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[ATTACHMENT],[DEPTIME],[ARVTIME]) 

 SELECT @LASTID ,[FROMSTATION],[TOSTATION],[DEPDATE],[ARRDATE],[TRAVELMODE],[TICKETNO],[FARE],[REMARK],@CREATEDBY,GETDATE(),1 ,[ATTACHMENT],[DEPTIME],[ARVTIME]

 FROM OPENXML(@IFAREDOCUMNET, 'NEWDATASET/TRAVEL_FARE', 2) WITH (

 [FROMSTATION] INT,[TOSTATION] INT ,[DEPDATE] DATETIME,[ARRDATE] DATETIME,[TRAVELMODE] INT,[TICKETNO] VARCHAR(100),[FARE] NUMERIC(13,2),[REMARK] VARCHAR(500),[ATTACHMENT] VARCHAR(250),[DEPTIME] VARCHAR(10),[ARVTIME] VARCHAR(10)) 

END

---END INSERT FARE EXPENSE

SELECT @TRAVELEXPCODE

END

 IF(@MODE='UPDATE')

 BEGIN

 ---INSERT TRAVEL_EXP_HDR

 UPDATE [DBO].[TRAVEL_EXP_HDR] SET [FROMDATE]=@FROMDATE,[TODATE]=@TODATE,[STATUS]=@STATUS,MODIFIEDBY=@CREATEDBY,MODIFIEDDATE=GETDATE(),TOTAL_AMOUNT=@TOTALAMOUNT WHERE TRVLEXPID=@TRVLEXPID

---INSERT TIFFIN EXP

IF(@XMLTIFFINDETAILS!='')

BEGIN

  DELETE FROM TRAVEL_TIFFIN  WHERE TRVLEXPID=@TRVLEXPID

  EXEC SP_XML_PREPAREDOCUMENT @IDOCUMNET OUTPUT,@XMLTIFFINDETAILS

  INSERT INTO TRAVEL_TIFFIN([TRVLEXPID],[DATE] ,[AMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARKS],[ATTACHMENT],[CITYID])

  SELECT @TRVLEXPID ,[DATE],[AMOUNT],@CREATEDBY,GETDATE(),1,[REMARKS],[ATTACHMENT],[CITYID]

  FROM OPENXML(@IDOCUMNET, 'NEWDATASET/TRAVEL_TIFFIN', 2) WITH ([DATE] DATETIME,[AMOUNT] NUMERIC(13,2),[REMARKS] NVARCHAR(500) ,[ATTACHMENT] VARCHAR(250),[CITYID] INT )

END

---END TIFFIN EXP

---INSERT LODGING EXPENSE START

IF(@XMLLODGINGDETAILS!='')

BEGIN

 DELETE FROM  TRAVEL_LODGING  WHERE TRVLEXPID=@TRVLEXPID

 EXEC SP_XML_PREPAREDOCUMENT @ILODGINGDOCUMNET OUTPUT 

 ,@XMLLODGINGDETAILS

INSERT INTO TRAVEL_LODGING([TRVLEXPID],[CITYID],[FROMDATE] ,[TODATE],[NIGHTSPENT],[AMOUNT],[DAAMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK],[ATTACHMENT],[LOCALITY],[BILLNO],[INTIME],[OUTTIME])

SELECT @TRVLEXPID,[CITYID] ,[FROMDATE],[TODATE],[NIGHTSPENT],[AMOUNT],[DAAMOUNT],@CREATEDBY,GETDATE(),1,[REMARK],[ATTACHMENT],[LOCALITY],[BILLNO], [INTIME], [OUTTIME] 

FROM OPENXML(@ILODGINGDOCUMNET, 'NEWDATASET/TRAVEL_LODGING', 2) WITH ([CITYID] INT,[FROMDATE] DATETIME,[TODATE] DATETIME,[NIGHTSPENT] INT,[AMOUNT] NUMERIC(13,2),[DAAMOUNT] NUMERIC(13,2),[REMARK] NVARCHAR(500),[ATTACHMENT] VARCHAR(250),[LOCALITY] VARCHAR(2
50),[BILLNO] VARCHAR(150),[INTIME] VARCHAR(10),[OUTTIME] VARCHAR(10)  )

END

---END INSERT LODGING EXPENSE

---INSERT OTHER EXPENSE START

IF(@XMLOTHERDETAILS!='')

BEGIN
--DELETE FROM TRAVEL_OTHER_DTL WHERE OTHERID IN(SELECT OTHER_ID FROM  TRAVEL_OTHER  WHERE TRVLEXPID=@TRVLEXPID)
--DELETE FROM  TRAVEL_OTHER  WHERE TRVLEXPID=@TRVLEXPID
DECLARE @CNT INT 
DECLARE @I INT 
EXEC SP_XML_PREPAREDOCUMENT @IOTHERDOCUMNET OUTPUT ,@XMLOTHERDETAILS

--INSERT INTO TRAVEL_OTHER([TRVLEXPID],[DATE] ,[OTHEREXP_AMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK])

SELECT @TRVLEXPID AS TRVLEXPID ,[DATE] AS ODATE,[OTHEREXP_AMOUNT] AS AMOUNT, [REMARK] AS REMARKS,[ATTACHMENT] AS ATTACHMENT,[ACCOUNTID] AS ACCOUNTID, ROW_NUMBER() OVER(ORDER BY DATE) AS ROWNO  INTO #TEMPOTHR

FROM OPENXML(@IOTHERDOCUMNET, 'NEWDATASET/TRAVEL_OTHER', 2) WITH ([DATE] DATETIME,[OTHEREXP_AMOUNT] NUMERIC(13,2),[REMARK] NVARCHAR(500) ,[ATTACHMENT] VARCHAR(250),[ACCOUNTID] INT)
SET @CNT=(SELECT COUNT(*) FROM #TEMPOTHR)
SET @I=1;
WHILE(@I<=@CNT)
BEGIN
DECLARE @ID INT,@DT DATETIME,@CNT2 INT ,@AMT DECIMAL(18,2), @RMK VARCHAR(200),@ATTECHMNT VARCHAR(250),@ACCOUNTID INT
SET @ID=(SELECT TRVLEXPID FROM #TEMPOTHR WHERE ROWNO=@I)
SET @DT=(SELECT ODATE FROM #TEMPOTHR WHERE ROWNO=@I)
SET @AMT=(SELECT AMOUNT FROM #TEMPOTHR WHERE ROWNO=@I)
SET @RMK=(SELECT REMARKS FROM #TEMPOTHR WHERE ROWNO=@I)
SET @ATTECHMNT=(SELECT ATTACHMENT FROM #TEMPOTHR WHERE ROWNO=@I)
SET @ACCOUNTID=(SELECT ACCOUNTID FROM #TEMPOTHR WHERE ROWNO=@I)
SET @CNT2 =(SELECT COUNT(*) FROM TRAVEL_OTHER WHERE TRVLEXPID=@ID AND CAST([DATE] AS DATE)=CAST(@DT AS DATE))
IF(@CNT2>0)
BEGIN
UPDATE TRAVEL_OTHER SET OTHEREXP_AMOUNT =@AMT,REMARK=@RMK,CREATEDDATE=GETDATE() ,[ATTACHMENT]=@ATTECHMNT,[ACCOUNTID]=@ACCOUNTID WHERE TRVLEXPID=@ID AND CAST([DATE] AS DATE)=CAST(@DT AS DATE)
END
ELSE
BEGIN
INSERT INTO TRAVEL_OTHER([TRVLEXPID],[DATE] ,[OTHEREXP_AMOUNT],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK],[ATTACHMENT],[ACCOUNTID]) VALUES
(@TRVLEXPID,@DT,@AMT,@CREATEDBY,GETDATE(),1,@RMK,@ATTECHMNT,@ACCOUNTID)
END
SET @I=@I+1;
END

END

---END INSERT OTHER EXPENSE

---INSERT TRAVEL EXPENSE START

IF(@XMLTRAVELDETAILS!='')

BEGIN

  DELETE FROM  TRAVEL_EXP_DETAIL  WHERE TRVLEXPID=@TRVLEXPID

  EXEC SP_XML_PREPAREDOCUMENT @ITRAVELDOCUMNET OUTPUT 

  ,@XMLTRAVELDETAILS

 INSERT INTO TRAVEL_EXP_DETAIL([TRVLEXPID],[DSRDTLID],[DATE] ,[SOURCE],[DESTINATION],[TRAVELMODEID],[FARE],[DISTANCE],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[REMARK],[ATTACHMENT])

 SELECT @TRVLEXPID ,[DSRDTLID],[DATE],[SOURCE],[DESTINATION],[TRAVELMODEID],[FARE],[DISTANCE],@CREATEDBY,GETDATE(),1,[REMARK],[ATTACHMENT]

 FROM OPENXML(@ITRAVELDOCUMNET, 'NEWDATASET/TRAVEL_EXP_DETAIL', 2)

 WITH ([DSRDTLID] INT ,[DATE] DATETIME,[SOURCE] VARCHAR(100),[DESTINATION] VARCHAR(100),[TRAVELMODEID] INT,[FARE] NUMERIC(13,2),[DISTANCE] NUMERIC(13,2),[REMARK] NVARCHAR(500),[ATTACHMENT] VARCHAR(250)  )

END

---END INSERT LODGING EXPENS

---INSERT FARE EXPENSE START

IF(@XMLFAREDETAILS!='')

BEGIN

  DELETE FROM  TRAVEL_FARE  WHERE TRVLEXPID=@TRVLEXPID

  EXEC SP_XML_PREPAREDOCUMENT @IFAREDOCUMNET OUTPUT,@XMLFAREDETAILS

  INSERT INTO TRAVEL_FARE([TRVLEXPID],[FROMSTATION],[TOSTATION] ,[DEPDATE],[ARRDATE],[TRAVELMODE],[TICKETNO],[FARE],[REMARK],[CREATEDBY] ,[CREATEDDATE] ,[STATUS],[ATTACHMENT],[DEPTIME],[ARVTIME])

  SELECT @TRVLEXPID ,[FROMSTATION],[TOSTATION],[DEPDATE],[ARRDATE],[TRAVELMODE],[TICKETNO],[FARE],[REMARK],@CREATEDBY,GETDATE(),1 ,[ATTACHMENT],[DEPTIME],[ARVTIME]

  FROM OPENXML(@IFAREDOCUMNET, 'NEWDATASET/TRAVEL_FARE', 2) WITH ([FROMSTATION] INT,[TOSTATION] INT ,[DEPDATE] DATETIME,[ARRDATE] DATETIME,[TRAVELMODE] INT,[TICKETNO] VARCHAR(100),[FARE] NUMERIC(13,2),[REMARK] VARCHAR(500),[ATTACHMENT] VARCHAR(250),[DEPTI
ME] VARCHAR(10),[ARVTIME] VARCHAR(10)) 

END

---END INSERT FARE EXPENSE

SELECT @TRAVELEXPCODE=TRAVELEXPCODE FROM TRAVEL_EXP_HDR WHERE TRVLEXPID=@TRVLEXPID
END

 IF (@MODE='APPROVED')
 BEGIN

  SELECT @COUNT=COUNT(1) FROM @NORMEDVAL

	IF( @COUNT>0)
	BEGIN
		DELETE FROM  TRAVEL_EXP_NORMANDVALUE WHERE TRVLEXPID=@TRVLEXPID
   
		INSERT INTO TRAVEL_EXP_NORMANDVALUE(TRVLEXPID,TRAVELCOMPID,NORMVALUE,ACTUALVALUE) 
		SELECT @TRVLEXPID,MST.TRAVELCOMPID ,NORMVALUE,ACTUALVALUE  FROM @NORMEDVAL AS NR
		INNER JOIN MST_TRAVELCOMPONENT MST ON NR.[KEY]=MST.COMPONENTCODE
	END

	DECLARE @CRETORID  INT=0,@EMPID INT=0,@DESIGNATIONID  INT=0,@TVLAPPROVALID INT=0,@APPROVALDESIGNATIONID INT=0,@ISFINALAPPROVAL VARCHAR(2) =''
	,@APPROVALLEVEL INT =0,@REGIONALMANAGER INT=0
	SELECT @CRETORID=[USER_ID] FROM TRAVEL_EXP_HDR WHERE TRVLEXPID= @TRVLEXPID
	SELECT @EMPID=EMP_ID FROM ADM_USER WHERE [USER_ID]=@CRETORID
	SELECT @STATUS=[STATUS],@APPROVALLEVEL=APPROVALLEVEL FROM DBO.[TRAVEL_EXP_HDR] WHERE TRVLEXPID=@TRVLEXPID
	
	IF @STATUS>=6
	BEGIN
	IF @ISADMIN='Y'
	   BEGIN
		SELECT @STATUS=STATUS_NUMBER,@ISFINALAPPROVAL=IS_FINALAPPROVAL,@APPROVALLEVEL=APPROVALLEVEL FROM MST_APPROVAL_HDR AS HDR
		INNER JOIN DBO.MST_FIELDROLE_HIER AS FRH ON HDR.FNC_ID=FRH.FNC_ID AND HDR.FIELD_ROLE=FRH.FIELD_ROLE
		INNER JOIN DBO.MST_APPROVAL_FNC AS FNC ON FRH.FNC_ID=FNC.FNC_ID
		WHERE FNC.CODE='EXP' AND APPROVALLEVEL=@APPROVALLEVEL+1

		UPDATE [DBO].[TRAVEL_EXP_HDR] SET [STATUS]=CASE WHEN @ISFINALAPPROVAL='Y' THEN [DBO].[FN_GETEXPENSSTATUSNUMBER]('APPROVED') ELSE @STATUS END,@APPROVALLEVEL=APPROVALLEVEL,MODIFIEDBY=@CREATEDBY,MODIFIEDDATE=GETDATE() WHERE TRVLEXPID=@TRVLEXPID
	   END
	   ELSE
	   BEGIN
		SELECT @STATUS=STATUS_NUMBER,@ISFINALAPPROVAL=IS_FINALAPPROVAL,@APPROVALLEVEL=APPROVALLEVEL FROM MST_APPROVAL_HDR AS HDR
		INNER JOIN DBO.MST_FIELDROLE_HIER AS FRH ON HDR.FNC_ID=FRH.FNC_ID AND HDR.FIELD_ROLE=FRH.FIELD_ROLE
		INNER JOIN DBO.MST_APPROVAL_FNC AS FNC ON FRH.FNC_ID=FNC.FNC_ID
		WHERE FNC.CODE='EXP' AND [USER_ID]=@USERID
		UPDATE [DBO].[TRAVEL_EXP_HDR] SET [STATUS]=CASE WHEN @ISFINALAPPROVAL='Y' THEN [DBO].[FN_GETEXPENSSTATUSNUMBER]('APPROVED') ELSE @STATUS END,@APPROVALLEVEL=APPROVALLEVEL,MODIFIEDBY=@CREATEDBY,MODIFIEDDATE=GETDATE() WHERE TRVLEXPID=@TRVLEXPID
		END		
	END
	ELSE
	BEGIN
	SELECT @REGIONALMANAGER=ISNULL(REGIONAL_MANAGER,0) FROM DBO.CM_EMP(NOLOCK) WHERE EMP_ID=@EMPID 
	UPDATE [DBO].[TRAVEL_EXP_HDR] SET [STATUS]=CASE WHEN [STATUS]=2 AND  @REGIONALMANAGER>0 THEN [DBO].[FN_GETEXPENSSTATUSNUMBER]('REPORTING') WHEN [STATUS]=2 AND @REGIONALMANAGER<=0  THEN [DBO].[FN_GETEXPENSSTATUSNUMBER]('REGIONAL')  ELSE  @STATUS+1 END
	                                 ,APPROVALLEVEL=@APPROVALLEVEL,MODIFIEDBY=@CREATEDBY,MODIFIEDDATE=GETDATE() WHERE TRVLEXPID=@TRVLEXPID
	END

   INSERT INTO TRAVEL_EXP_APPROVAL(TRVLEXPID,APPROVALID,[STATUS],REMARKS,CREATEDBY,CREATEDDATE)	
   SELECT @TRVLEXPID,@USERID,@STATUS,@REMARKS,@CREATEDBY,GETDATE()

 END
 IF (@MODE='REJECT')
 BEGIN
  SELECT @COUNT=COUNT(1) FROM @NORMEDVAL
  IF( @COUNT>0)
	BEGIN
	   DELETE FROM  TRAVEL_EXP_NORMANDVALUE WHERE TRVLEXPID=@TRVLEXPID
	   INSERT INTO TRAVEL_EXP_NORMANDVALUE(TRVLEXPID,TRAVELCOMPID,NORMVALUE,ACTUALVALUE)   
	   SELECT @TRVLEXPID, MST.TRAVELCOMPID, NORMVALUE,ACTUALVALUE  FROM @NORMEDVAL AS NR
	   INNER JOIN MST_TRAVELCOMPONENT MST ON NR.[KEY]=MST.COMPONENTCODE
	END

 UPDATE [DBO].[TRAVEL_EXP_HDR] SET [STATUS]=[DBO].[FN_GETEXPENSSTATUSNUMBER]('REJECTED'),MODIFIEDBY=@CREATEDBY,MODIFIEDDATE=GETDATE() WHERE TRVLEXPID=@TRVLEXPID
  INSERT INTO TRAVEL_EXP_APPROVAL(TRVLEXPID,APPROVALID,[STATUS],REMARKS,CREATEDBY,CREATEDDATE)	  
  SELECT @TRVLEXPID,@USERID,[DBO].[FN_GETEXPENSSTATUSNUMBER]('REJECTED') AS [STATUS],@REMARKS,@CREATEDBY,GETDATE()
 END
END


